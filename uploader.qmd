---
format:
  dashboard:
    embed-resources: true
    orientation: columns
execute:
  echo: false
  cache: true
---

```{r}
#| echo: false
#| message: false
#| eval: true

library(tidyverse)
library(dplyr)

#-------- getMetadata(erddap_id) --------------
# Get subset of metadata by column and erddap_id
# We could read directly from the spreadsheet on the Google Drive, but downloading the csv file ensures
# that everyone is using the same metadata.csv file, and it can easily be archived by ESR year

getMetadata <-function(erddap_id){

  df = read.csv('metadata.csv')
  df_trimmed<- df %>% select(c('Component_Section', 'Subcomponent', 'ERDDAP_Dataset_ID', 'ERDDAP_query_value', 'Contact', 'Title', 'Institution', 'Source_Data', 'Additional_Calculations', 'region', 'latitude', 'longitude', 'latitude2', 'longitude2','Sampling_frequency','Figure_grouping','year_begin','year_end'))
  meta <- df_trimmed %>% filter(currently_served==1)
  meta <- meta[order(meta$Figure_grouping),]
  return(meta)
}

``` 

```{ojs}
//| echo: false
//| output: false

name=Array()
data = FileAttachment("data/items_meta.json").json()
pis=data.pis

{ for(let i=0;i<pis.length;i++){
    name[i]=pis[i].name
    }
  return name
}

//ojs_define(pis = pis)
```

```{ojs}
//| echo: false
//| output: false
components=pis[indx].components

```

## PI {.tabset}

### View Current

#### {height=15%}

#####

```{ojs}
viewof pi = Inputs.select(name,{value:name[0], label: "Choose PI" });
indx=name.indexOf(pi)
viewof component = Inputs.select(components,{format: x => x.name, label: "Component" });
 
```

#### Indicators {height=35%}

#####

```{ojs}

viewof indicator=Inputs.radio(component.indices,{value: component.indices[0]})

```

####

#####

```{ojs}
indicator

```

### Download Last Year

#### Download buttons {height=35%}

#####

```{ojs}

viewof lastyear = Inputs.button("Last Year",{value: pis[indx].last_year, label: "View or download Last Year's data", reduce: () => window.open("https://drive.google.com/drive/folders/"+pis[indx].last_year,"_blank")})

last_meta='https://oceanview.pfeg.noaa.gov/erddap/tabledap/CCIEA_metadata.csv?dataset_title,indicator_title,long_variable_name,units,info_URL,institution,region,latitude,max_latitude,longitude,max_longitude,sampling_frequency,source_data_summary,additional_calculations,cciea_timeseries_id&currently_served=1&principal_investigator_id="'+pis[indx].id+'"'

viewof lastmeta = Inputs.button("Current Metadata",{value: pis[indx].this_year, label: "Download and edit current metadata", reduce: () => window.open(last_meta)})
```

### Upload This Year


```{ojs}
viewof thisyear = Inputs.button("This Year",{value: pis[indx].this_year, label: "Upload This Year's data", reduce: () => window.open("https://drive.google.com/drive/folders/"+pis[indx].this_year,"_blank")})

//url="https://drive.google.com/drive/folders/"+last
//html`<a href=${url} target=_blank>${url}</a>`



ind_url="https://oceanview.pfeg.noaa.gov/erddap/tabledap/CCIEA_metadata.json?&currently_served=1&indicator_title="+'"'+encodeURIComponent(indicator)+'"'


```

